#!/bin/bash

SRCVER=bifrost-6.2
PKG=$SRCVER-1 # with build version

# PKGDIR is set by 'pkg_build'. Usually "/var/lib/build/$PKG".
PKGDIR=${PKGDIR:-/var/lib/build/$PKG}
SRC=/var/spool/src/$SRCVER.tar.gz
BUILDDIR=/var/tmp/src/$SRCVER
DST="/var/tmp/install/$PKG"

#########
# Simple inplace edit with sed.
# Usage: sedit 's/find/replace/g' Filename
function sedit {
    sed "$1" $2 > /tmp/sedit.$$
    cp /tmp/sedit.$$ $2
    rm /tmp/sedit.$$
}

#########
# Fetch sources
./Fetch-source.sh || exit 1
pkg_uninstall # Uninstall any dependencies used by Fetch-source.sh

#########
# Install dependencies:
pkg_available bifrost-framework-1.0.1-1
pkg_available bash-4.1-1 bc-1.06-1 bind-9.7.0-P2-1 bzip2-bin-1.0.5-1
pkg_available coreutils-7.6-1 cronie-1.4.4-1 dialog-1.1-20100428-1

pkg_install findutils-4.4.2-1 || exit 2

#########
# Install into dir under /var/tmp/install
function untar {
    if [ ! -f /var/spool/pkg/$1.tar.gz ]; then
	pkg_build $1
	exit 2
    fi
	tar xvf /var/spool/pkg/$1.tar.gz $2
}
rm -rf "$DST"
mkdir -p "$DST"
cd $DST
untar bifrost-framework-1.0.1-1

untar bifrost-admin-1

untar arping-2.09-1
untar arpwatch-2.1a15-1
untar bash-4.1-1
untar bind-9.7.0-P2-1 ./bin/host
untar binutils-2.20.1-1 ./usr/bin/size
untar binutils-2.20.1-1 ./usr/bin/objdump
untar binutils-2.20.1-1 ./usr/bin/ar
untar binutils-2.20.1-1 ./usr/bin/strings
untar binutils-2.20.1-1 ./usr/bin/ranlib
untar binutils-2.20.1-1 ./usr/bin/readelf
untar binutils-2.20.1-1 ./usr/bin/nm
untar binutils-2.20.1-1 ./usr/bin/strip
untar bridge-utils-1.4-1
untar bzip2-bin-1.0.5-1
untar conntrack-tools-0.9.14-1
untar coreutils-7.6-1
untar cpuinfo-1.1-1
untar cpuburn_1_4-1
untar cpu_pkts-1-1
untar cronie-1.4.4-1
untar curl-7.20.1-1
untar dhcp-4.1.1-1
untar dhcpcd-4.0.15-1
untar diffutils-3.0-1
untar dmidecode-2.10-1 
untar dnsmasq-2.52-1
untar e2fsprogs-1.41.11-1
untar eth-affinity-1.2.3-1
untar ethtool-v2.6.35-2
untar file-5.04-1
untar findutils-4.4.2-1
untar grep-2.6.3-1
untar gzip-1.4-1
untar ifinfo-1.6-1
untar ipmitool-1.8.11-1
untar iproute2-2.6.34-1
untar iptables-1.4.8-1
untar iputils-s20100418-2
untar kbd-1.15.2-1
untar kexec-tools-2.0.2-rc2-1
untar less-436-1
untar libcap-bin-2.19-1
untar logrotate-3.7.3-1
untar loop-1-1
untar lsof-4.84-1

untar make_bifrost-1
untar mcelog-1.0pre3-1
untar module-init-tools-3.12-1
untar ncftp-3.2.5-1 ./usr/bin/ncftp
untar netkit-base-0.17-1 ./sbin/inetd
untar netperf-2.4.5-1
untar net-tools-1.60-2
untar nmap-5.21-1
untar ntp-4.2.6p2-1
untar numactl-2.0.6-1 ./usr/bin/numactl
untar openssh-5.5p1-1
untar openssl-0.9.8q-1 ./usr/bin/openssl
untar pciutils-3.1.7-1
untar procps-3.2.8-2
untar psmisc-22.11-1
untar remount-2-1
untar schedlat-1.2-1
untar shadow-4.1.4.2-1
untar strace-4.5.20-1
untar sysfsutils-2.1.0-1 ./usr/bin/systool
untar sysfsutils-2.1.0-1 ./usr/bin/dlist_test
untar sysfsutils-2.1.0-1 ./usr/bin/get_device
untar sysfsutils-2.1.0-1 ./usr/bin/get_driver
untar sysfsutils-2.1.0-1 ./usr/bin/get_module
untar sysklogd-1.4.1-1
untar sysvinit-2.86-1
untar tar-1.23-1
untar tcpdump-4.1.1-1
untar tcp_wrappers-bin-7.6-1 ./sbin/tcpd
untar telnet-bsd-1.2-1
untar time-1.7-1
untar traceroute-2.0.16-1
untar util-linux-ng-bin-2.17.2-2
untar vlan.1.9-1
untar vlock-1.4-1 ./usr/bin/vlock && mv usr/bin/vlock usr/bin/lock
untar wget-1.12-1
untar which-2.20-1
untar whois_5.0.10-1
untar wireless_tools.29-1

#########
# Clean up
cd $DST

function p {
    while read F; do
	basename $F
    done
}

find $1 -executable \! -type d \! -type l| p | sort | uniq > /tmp/b.list

#########
# Make package
cd $DST
tar czf /var/spool/pkg/$PKG.tar.gz .

#########
# Cleanup after a success
cd /var/lib/build
[ "$DEVEL" ] || rm -rf "$DST"
[ "$DEVEL" ] || rm -rf "$BUILDDIR"
pkg_uninstall
exit 0
