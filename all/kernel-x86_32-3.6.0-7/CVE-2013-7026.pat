--- ipc/shm.c.orig	Wed Jul 16 10:39:30 2014
+++ ipc/shm.c	Wed Jul 16 11:18:55 2014
@@ -187,15 +187,18 @@
  */
 static void shm_destroy(struct ipc_namespace *ns, struct shmid_kernel *shp)
 {
+        struct file *shm_file;
+
+        shm_file = shp->shm_file;
+        shp->shm_file = NULL;
 	ns->shm_tot -= (shp->shm_segsz + PAGE_SIZE - 1) >> PAGE_SHIFT;
 	shm_rmid(ns, shp);
 	shm_unlock(shp);
-	if (!is_file_hugepages(shp->shm_file))
-		shmem_lock(shp->shm_file, 0, shp->mlock_user);
+        if (!is_file_hugepages(shm_file))
+                shmem_lock(shm_file, 0, shp->mlock_user);
 	else if (shp->mlock_user)
-		user_shm_unlock(shp->shm_file->f_path.dentry->d_inode->i_size,
-						shp->mlock_user);
-	fput (shp->shm_file);
+                user_shm_unlock(shm_file->f_path.dentry->d_inode->i_size, shp->mlock_user);
+        fput(shm_file);
 	security_shm_free(shp);
 	ipc_rcu_putref(shp);
 }
